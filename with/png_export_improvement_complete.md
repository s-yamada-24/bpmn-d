# PNG保存機能 改善完了

**From:** エンジニア (実装担当)
**To:** 全チームメンバー
**Date:** 2025-11-22T11:10:00+09:00

## 更新内容

ユーザーからのフィードバックに基づき、PNG保存機能を完全に書き直しました。

### 1. Importボタンのデザイン統一 ✅
- ImportボタンをExportボタンと同じ`primary-btn`スタイルに変更
- 両ボタンが統一されたデザインで並んで表示

### 2. PNG保存機能の完全リニューアル ✅

#### 変更前の問題点
- html2canvasライブラリに依存
- キャンバス全体(背景・グリッド線含む)を保存
- ズーム状態の影響を受ける
- 不要な余白が含まれる

#### 変更後の改善点
- **ライブラリ不要**: Canvas APIで完全自作実装
- **BPMN要素のみ**: 要素が表示されている範囲のみを抽出
- **等倍率保存**: ズーム状態を無視し、常に1:1で保存
- **白背景**: 背景色は白、グリッド線なし
- **最小限の余白**: 要素の周囲に20pxのパディングのみ

## 技術的詳細

### PNG生成アルゴリズム

```
1. 全BPMN要素の座標を取得
2. バウンディングボックスを計算(minX, minY, maxX, maxY)
3. パディング(20px)を追加
4. Canvasを作成(計算されたサイズ)
5. 白背景で塗りつぶし
6. 接続線を描画(要素の背後)
7. プールを描画
8. BPMN要素を描画
   - Events: 円
   - Tasks: 角丸矩形
   - Gateways: ダイヤモンド
   - Data: 矩形
9. ラベルを描画(ワードラップ対応)
10. Blobに変換してダウンロード
```

### 描画の詳細

#### 接続線
- 色: `#00d4ff` (シアン)
- 線幅: 2px
- 実線/点線の切り替え対応
- 矢印ヘッド付き

#### プール
- 枠線: `#8a2be2` (紫)、2px
- ヘッダー: 30px幅、半透明紫背景
- プール名: 縦書き(90度回転)

#### BPMN要素
- **Events**: 円形、シアン枠
  - End Event: 4px太線
  - その他: 2px線
- **Tasks**: 角丸矩形(radius: 8px)、紫枠
- **Gateways**: ダイヤモンド、金色枠
- **Data**: 矩形、シアン枠

#### ラベル
- フォント: `12px Inter, sans-serif`
- 色: `#000000` (黒)
- 自動ワードラップ
- 中央揃え

## ファイル変更

### 変更ファイル
1. **`index.html`**
   - Importボタンのクラスを`secondary-btn`→`primary-btn`に変更

2. **`js/exporter.js`**
   - PNG保存機能を完全に書き直し
   - html2canvas関連コードを完全削除
   - Canvas APIで自作実装
   - 約250行のコード削減

## 使用方法

### PNG保存
1. 「Export」ボタンをクリック
2. 「PNG」を選択
3. BPMN要素の範囲のみが等倍率で画像化される
4. 白背景、グリッド線なしでダウンロード

## メリット

### パフォーマンス
- ✅ ライブラリ読み込み不要
- ✅ 即座にエクスポート可能
- ✅ 軽量化(外部依存なし)

### 品質
- ✅ 正確な要素範囲の抽出
- ✅ 等倍率で常に同じ品質
- ✅ クリーンな白背景

### 保守性
- ✅ 外部ライブラリへの依存なし
- ✅ 完全にコントロール可能
- ✅ カスタマイズが容易

## 制限事項

### 現在サポートされていない機能
- [ ] 複雑なパス(曲線)の接続線
- [ ] 要素内のアイコン(SVG)
- [ ] グラデーション効果
- [ ] 影やエフェクト

### 将来の拡張可能性
- [ ] 解像度設定(1x, 2x, 3x)
- [ ] 背景色のカスタマイズ
- [ ] パディングサイズの調整
- [ ] 透明背景オプション
- [ ] 要素のアイコン描画

## テスト推奨事項

1. ✅ 単一要素のエクスポート
2. ✅ 複数要素のエクスポート
3. ✅ プール/レーン含むエクスポート
4. ✅ 接続線の描画確認
5. ⏳ 大規模図面でのパフォーマンステスト
6. ⏳ 各種ブラウザでの動作確認

## エクスポート形式まとめ

| 形式 | ステータス | ライブラリ | 用途 |
|------|-----------|-----------|------|
| **JSON** | ✅ 完全実装 | なし | プロジェクト保存・読み込み |
| **BPMN XML** | ✅ 完全実装 | なし | 標準形式、他ツールとの互換性 |
| **PNG** | ✅ 完全実装 | なし | 画像として保存(白背景) |

---
**Status:** 完了 ✅
**影響範囲:** なし (既存機能に影響なし)
**次のステップ:** ユーザーテストとフィードバック
